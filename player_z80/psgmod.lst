                                        .IFNDEF PSGMOD_SUPPORT_GG_STEREO
                                          .PRINTT "psgmod.asm:\n"
                                          .PRINTT "PSGMOD_SUPPORT_GG_STEREO must be defined.\n"
                                          .FAIL
                                        .ENDIF
                                        .IFNDEF PSGMOD_START_ADDRESS
                                          .PRINTT "psgmod.asm:\n"
                                          .PRINTT "PSGMOD_START_ADDRESS must be defined.\n"
                                          .FAIL
                                        .ENDIF
                                        .IF PSGMOD_START_ADDRESS & 255 != 0
                                          .PRINTT "psgmod.asm:\n"
                                          .PRINTT "PSGMOD_START_ADDRESS must be aligned to 256 bytes.\n"
                                          .FAIL
                                        .ENDIF
                                        
                                        ;--------------------------
                                        ; PSGMOD_LoadModule(A, HL)
                                        PSGMOD_LoadModule:
$47                                       ld   b, a
$3A $00 $80                               ld   a, (PSGMOD_MAPPER_ADDRESS)
$F5                                       push af
$78                                       ld   a, b
$32 $4B $C2                               ld   (PSGMOD_FRAME), a
$32 $00 $80                               ld   (PSGMOD_MAPPER_ADDRESS), a
$22 $55 $C2                               ld   (PSGMOD_ADDRESS), hl
                                          
$4E                                       ld   c, (hl)
$23                                       inc  hl
$46                                       ld   b, (hl)
$23                                       inc  hl
$ED $43 $04 $C2                           ld   (PSGMOD_LENGTH), bc
$ED $43 $06 $C2                           ld   (PSGMOD_LENGTH_CNT), bc
                                          
$11 $00 $C1                               ld   de, PSGMOD_INSTRUMENTS
$01 $00 $01                               ld   bc, 256
$ED $B0                                   ldir
                                          
$1E $15                                   ld   e, PSGMOD_INITIAL_SPEED & 255
$ED $A0                                   ldi
$ED $A0                                   ldi ; INITIAL_GG_STEREO
$ED $A0                                   ldi ; REPEAT_POINT
$ED $A0                                   ldi
                                          
$22 $00 $C2                               ld   (PSGMOD_SEQ_LIST_START_PTR), hl
$22 $02 $C2                               ld   (PSGMOD_SEQ_LIST_PTR), hl
$CD $77 $03                               call PSGMOD_StartSequences
                                          
$CD $A6 $00                               call PSGMOD_ResetPlayer
                                          
$F1                                       pop  af
$32 $00 $80                               ld   (PSGMOD_MAPPER_ADDRESS), a
$C9                                       ret
                                        
                                        ;-------------------
                                        PSGMOD_ResetPlayer:
$3A $15 $C2                               ld a, (PSGMOD_INITIAL_SPEED)
$32 $19 $C2                               ld (PSGMOD_SPEED), a
$3A $16 $C2                               ld a, (PSGMOD_INITIAL_GG_STEREO)
$32 $1C $C2                               ld (PSGMOD_GG_STEREO), a
                                          
$3E $07                                   ld   a, 7
$32 $1A $C2                               ld   (PSGMOD_SPEED_CNT), a
$AF                                       xor  a
$32 $4C $C2                               ld   (PSGMOD_STARTED), a
                                          
$21 $00 $C1                               ld hl, PSGMOD_INSTRUMENTS
$22 $1F $C2                               ld (PSGMOD_INSTR_PTR), hl
$22 $21 $C2                               ld (PSGMOD_INSTR_PTR+2), hl
$22 $23 $C2                               ld (PSGMOD_INSTR_PTR+4), hl
$22 $25 $C2                               ld (PSGMOD_INSTR_PTR+6), hl
                                          
$21 $01 $01                               ld hl, $0101
$22 $10 $C2                               ld (PSGMOD_SEQ_WAIT), hl
$22 $12 $C2                               ld (PSGMOD_SEQ_WAIT+2), hl
$25                                       dec h
$2D                                       dec l
$22 $23 $C2                               ld (PSGMOD_PHASE_VOLUME), hl
$22 $25 $C2                               ld (PSGMOD_PHASE_VOLUME+2), hl
$22 $36 $C2                               ld (PSGMOD_VOLUME), hl
$22 $38 $C2                               ld (PSGMOD_VOLUME+2), hl
$22 $40 $C2                               ld (PSGMOD_PULSE_VIBRATO), hl
                                          ; A = 0
$32 $27 $C2                               ld (PSGMOD_PHASE_VOLUME_ADD_0), a
$32 $29 $C2                               ld (PSGMOD_PHASE_VOLUME_ADD_1), a
$32 $2B $C2                               ld (PSGMOD_PHASE_VOLUME_ADD_2), a
$32 $2D $C2                               ld (PSGMOD_PHASE_VOLUME_ADD_3), a
$32 $42 $C2                               ld (PSGMOD_PULSE_VIBRATO + 2), a
$3D                                       dec a
$32 $28 $C2                               ld (PSGMOD_PHASE_DELAY_0), a
$32 $2A $C2                               ld (PSGMOD_PHASE_DELAY_1), a
$32 $2C $C2                               ld (PSGMOD_PHASE_DELAY_2), a
$32 $2E $C2                               ld (PSGMOD_PHASE_DELAY_3), a
                                          ; H = 0
$2E $F0                                   ld l, $F0
$22 $2F $C2                               ld (PSGMOD_FREQUENCY), hl
$22 $31 $C2                               ld (PSGMOD_FREQUENCY + 2), hl
$22 $33 $C2                               ld (PSGMOD_FREQUENCY + 4), hl
$3E $E0                                   ld a, $E0                            ; high periodic noise
$32 $35 $C2                               ld (PSGMOD_FREQUENCY+6), a
$21 $0D $0D                               ld hl, 13 + (13 << 8)
$22 $1F $C2                               ld (PSGMOD_INSTR_PTR), hl
$22 $21 $C2                               ld (PSGMOD_INSTR_PTR+2), hl
$21 $00 $80                               ld hl, $8000
$22 $3A $C2                               ld (PSGMOD_VIBPOS), hl
$22 $3C $C2                               ld (PSGMOD_VIBPOS+2), hl
$22 $3E $C2                               ld (PSGMOD_VIBPOS+4), hl
$3E $55                                   ld a, $55 ; Eigentlich $AA; wegen erstem TriggerLine
$32 $1B $C2                               ld (PSGMOD_PULSE_VIBRATO_MASK), a
$C9                                       ret
                                        
                                        ;----------------
                                        ; PSGMOD_Start()
                                        PSGMOD_Start:
$3E $01                                   ld   a, 1
$C3 $31 $01                               jp   +
                                        ;----------------
                                        ; PSGMOD_Pause()
                                        PSGMOD_Pause:
$AF                                       xor  a
                                        +:
$32 $4C $C2                               ld   (PSGMOD_STARTED), a
                                        ;----------------
                                        PSGMOD_ResetPSG:
$01 $7F $0A                               ld   bc, (10 << 8) | (PSGMOD_PSG_PORT)
$21 $42 $01                               ld   hl, PSGMOD_ResetPSG_Table
$ED $B3                                   otir
                                          
$3A $35 $C2                               ld   a, (PSGMOD_FREQUENCY + 6)
$D3 $7F                                   out  (PSGMOD_PSG_PORT), a
$C9                                       ret
                                        PSGMOD_ResetPSG_Table:
                                        ; Set all volumes to 0
$9F $BF $DF $FF                         .db (15|144),(15|144)+32,(15|144)+64,(15|144)+96
                                        ; Set tone channel frequencies to 0
$80 $00 $A0 $00 $C0 $00                 .db 128,0,128+32,0,128+64,0
                                        
                                        ;---------------
                                        ; PSGMOD_Play()
                                        PSGMOD_Play:
$3A $4C $C2                               ld   a, (PSGMOD_STARTED)
$A7                                       and  a
$CA $34 $01                               jp   Z, PSGMOD_ResetPSG
                                        ;-------------------------------------------------------
                                          
                                          ;
                                          ; Trigger line
                                          ;
$3A $1A $C2                               ld   a, (PSGMOD_SPEED_CNT)
$D6 $08                                   sub  8
$DA $E0 $03                               jp   C, PSGMOD_Play_TriggerLine
$32 $1A $C2                               ld   (PSGMOD_SPEED_CNT), a
                                        PSGMOD_Play_TriggerLine_Cont:
                                          
                                          ;
                                          ; Soundeffekte
                                          ;
$3A $4D $C2                               ld a, (PSGMOD_SFX_2_PRIORITY)
$B7                                       or a
$28 $44                                   jr Z, PSGMOD_Play_NoSFX_2
                                          
$21 $4F $C2                               ld hl, PSGMOD_SFX_2_CNT
$7E                                       ld a, (hl)
$D6 $01                                   sub 1                           ; nicht dec, wegen C-Flag
$77                                       ld (hl), a
                                          ;cp -1
$30 $2F                                   jr NC, PSGMOD_Play_NoSFX_2_End
                                          
$AF                                       xor a
$32 $4D $C2                               ld (PSGMOD_SFX_2_PRIORITY), a
                                          
                                          ;
                                          ; Frequenz zurücksetzen
                                          ;
$3A $1B $C2                               ld a, (PSGMOD_PULSE_VIBRATO_MASK)
$B7                                       or a
$2A $33 $C2                               ld hl, (PSGMOD_FREQUENCY+4)
$28 $07                                   jr Z, PSGMOD_Play_ResetFreq2_NoVib
$16 $00                                   ld d, 0
$3A $42 $C2                               ld a, (PSGMOD_PULSE_VIBRATO + 2)
$5F                                       ld e, a
$19                                       add hl, de
                                        PSGMOD_Play_ResetFreq2_NoVib:
                                          
$7D                                       ld a, l
$E6 $0F                                   and 15
$F6 $C0                                   or 128+64
$D3 $7F                                   out (PSGMOD_PSG_PORT), a
                                          
$7D                                       ld a, l
$0F                                       rrca
$0F                                       rrca
$0F                                       rrca
$0F                                       rrca
$E6 $0F                                   and 15
$47                                       ld b, a
$7C                                       ld a, h
$E6 $03                                   and 3
$0F                                       rrca
$0F                                       rrca
$0F                                       rrca
$0F                                       rrca
$B0                                       or b
$D3 $7F                                   out (PSGMOD_PSG_PORT), a
                                          ;
                                          ;
                                          ;
$18 $0C                                   jr PSGMOD_Play_NoSFX_2
                                        PSGMOD_Play_NoSFX_2_End:
                                          
$2A $51 $C2                               ld hl, (PSGMOD_SFX_2_ADDRESS)
$ED $A3                                   outi
$ED $A3                                   outi
$ED $A3                                   outi
$22 $51 $C2                               ld (PSGMOD_SFX_2_ADDRESS), hl
                                          
                                        PSGMOD_Play_NoSFX_2:
                                          
$3A $4E $C2                               ld a, (PSGMOD_SFX_3_PRIORITY)
$B7                                       or a
$28 $27                                   jr Z, PSGMOD_Play_NoSFX_3
                                          
$21 $50 $C2                               ld hl, PSGMOD_SFX_3_CNT
$7E                                       ld a, (hl)
$D6 $01                                   sub 1                           ; nicht dec, wegen C-Flag
$77                                       ld (hl), a
                                          ;cp -1
$30 $0B                                   jr NC, PSGMOD_Play_NoSFX_3_End
                                          
$AF                                       xor a
$32 $4E $C2                               ld (PSGMOD_SFX_3_PRIORITY), a
$3A $35 $C2                               ld a, (PSGMOD_FREQUENCY + 6)
$D3 $7F                                   out (PSGMOD_PSG_PORT), a
$18 $13                                   jr PSGMOD_Play_NoSFX_3
                                          
                                        PSGMOD_Play_NoSFX_3_End:
$2A $53 $C2                               ld hl, (PSGMOD_SFX_3_ADDRESS)
$7E                                       ld a, (hl)
$23                                       inc hl
$B7                                       or a
$28 $04                                   jr Z, PSGMOD_Play_SFX_3_
$7E                                       ld a, (hl)
$23                                       inc hl
$D3 $7F                                   out (PSGMOD_PSG_PORT), a
                                          PSGMOD_Play_SFX_3_:
$7E                                       ld a, (hl)
$23                                       inc hl
$D3 $7F                                   out (PSGMOD_PSG_PORT), a
$22 $53 $C2                               ld (PSGMOD_SFX_3_ADDRESS), hl
                                          
                                        PSGMOD_Play_NoSFX_3:
                                          
                                        ;-------------------------------------------------------
                                          
                                        .MACRO _PSGMOD_SET_TONE_CHANNEL_PSG
                                          ; \1 == Channel
                                          ; \2 == Channel * 2
                                          ; C = 15
                                          
                                          ; Volume
                                          .IF \1 == 2
$3A $4D $C2                               ld   a, (PSGMOD_SFX_2_PRIORITY)
$A7                                       and  a
$20 $47                                   jr   NZ, ++
                                          .ENDIF
                                          .IF \1 == 3
$3A $4E $C2                               ld   a, (PSGMOD_SFX_3_PRIORITY)
$A7                                       and  a
$20 $16                                   jr   NZ, ++
                                          .ENDIF
                                          
$3A $36 $C2                               ld   a, (PSGMOD_VOLUME + \1)
$3A $38 $C2                               ld   d, a
$3A $37 $C2                               ld   a, (PSGMOD_PHASE_VOLUME + \1)
$3A $39 $C2                               rrca
$57                                       rrca
$57                                       rrca
$57                                       rrca
$57                                       and  c
$3A $26 $C2                               add  a, d
$3A $23 $C2                               sub  c
$3A $24 $C2                               jp   NC, +
$3A $25 $C2                               xor  a
$0F                                     +:
$0F                                       xor  ($60 - (32 * \1)) ~ $FF
$0F                                       out  (PSGMOD_PSG_PORT), a
$0F                                       
$0F                                       ; Frequency
$0F                                       .IF \1 != 3
$0F                                       ld   hl, (PSGMOD_FREQUENCY + \2)
$0F                                       
$0F                                       ld   de, 0
$0F                                       ld   a, (PSGMOD_PULSE_VIBRATO_MASK)
$0F                                       rrca
$0F                                       jp   NC, +
$0F                                       ld   a, (PSGMOD_PULSE_VIBRATO + \1)
$0F                                       ld   e, a
$0F                                     +:
$0F                                       add  hl, de
$A1                                       ld   a, l
$A1                                       or   $F0
$A1                                       ld   l, a
$A1                                       ld   de, (PSGMOD_VIBPOS + \2)
$82                                       ld   a, (de)
$82                                       ld   b, a
$82                                       inc  e
$82                                       ld   a, (de)
$91                                       ld   d, a
$91                                       inc  e
$91                                       ld   a, e
$91                                       ld   (PSGMOD_VIBPOS + \2), a
$D2 $CF $02                               ld   e, b
$D2 $82 $02                               add  hl, de
$D2 $35 $02                               
$D2 $EE $01                               ld   a, l
$AF                                       and  c
$AF                                       or   128 + (32 * \1)
$AF                                       out  (PSGMOD_PSG_PORT), a
$AF                                       
$EE $BF                                   ld   a, h
$EE $DF                                   and  63
$EE $FF                                   out  (PSGMOD_PSG_PORT), a
$EE $9F                                   .ENDIF
$D3 $7F                                   
$D3 $7F                                 ++:
$D3 $7F                                 .ENDM
$D3 $7F                                   
$2A $2F $C2                               .IF PSGMOD_SUPPORT_GG_STEREO == 1
$2A $31 $C2                               ld   a, (PSGMOD_GG_STEREO)
$2A $33 $C2                               out  ($06), a
$11 $00 $00                               .ENDIF
$11 $00 $00                               
$11 $00 $00                               ld   a, :PSGMOD_VIBRATO_TABLES
$3A $1B $C2                               ld   (PSGMOD_MAPPER_ADDRESS), a
$3A $1B $C2                               
$3A $1B $C2                               ld   c, 15
$0F                                       _PSGMOD_SET_TONE_CHANNEL_PSG 0, 0
$0F                                       _PSGMOD_SET_TONE_CHANNEL_PSG 1, 2
$0F                                       _PSGMOD_SET_TONE_CHANNEL_PSG 2, 4
$D2 $97 $02                               _PSGMOD_SET_TONE_CHANNEL_PSG 3, 6
$D2 $03 $02                               
$D2 $4A $02                             ;-------------------------------------------------------
$3A $40 $C2                               
$3A $41 $C2                             .MACRO PSGMOD_PLAY_INSTRUMENT
$3A $42 $C2                               ld   a, (PSGMOD_PHASE_VOLUME + \1)
$5F                                       .IF \1 == 0
$5F                                       ld   hl, PSGMOD_PHASE_VOLUME_ADD_0 + \2
$5F                                       .ELSE
$19                                       ld   l, (PSGMOD_PHASE_VOLUME_ADD_0 + \2) & 255
$19                                       .ENDIF
$19                                       add  a, (hl)
$7D                                       ld   (PSGMOD_PHASE_VOLUME + \1), a
$7D                                       
$7D                                       .IF PSGMOD_PHASE_DELAY_0 != PSGMOD_PHASE_VOLUME_ADD_0 + 1
$F6 $F0                                     .FAIL
$F6 $F0                                   .ENDIF
$F6 $F0                                   ;ld   l, (PSGMOD_PHASE_DELAY_0 + \2) & 255
$6F                                       inc  l
$6F                                       dec  (hl)
$6F                                       .IF \1 == 3
$ED $5B $3C $C2                           ret  NZ                                        ; s.u.
$ED $5B $3A $C2                           .ELSE
$ED $5B $3E $C2                           jp   NZ, PSGMOD_Play_PhasesDone\1
$1A                                       .ENDIF
$1A                                       
$1A                                       ld   d, h
$47                                       dec  h
$47                                       ld   a, (PSGMOD_INSTR_PTR + \1)
$47                                       ld   l, a
$1C                                       ld   e, (PSGMOD_PHASE_VOLUME_ADD_0 + \2) & 255
$1C                                       ldi
$1C                                       ldi
$1A                                       .IF \1 != 3
$1A                                       ld a, (hl)
$1A                                       ld (PSGMOD_VIBPOS + \2 + 1), a
$57                                       .ENDIF
$57                                       inc l
$57                                       ld a, l
$1C                                       and 15
$1C                                       jp  Z, +
$1C                                       ld a, l
$7B                                       ld (PSGMOD_INSTR_PTR + \1), a
$7B                                     +:
$7B                                       inc h
$32 $3C $C2                             PSGMOD_Play_PhasesDone\1:
$32 $3A $C2                             .ENDM
$32 $3E $C2                               
$58                                       PSGMOD_PLAY_INSTRUMENT 0, 0
$58                                       PSGMOD_PLAY_INSTRUMENT 1, 2
$58                                       PSGMOD_PLAY_INSTRUMENT 2, 4
$19                                       PSGMOD_PLAY_INSTRUMENT 3, 6
$19                                       ret
$19                                     
$7D                                     PSGMOD_StartSequences: ; (HL)
$7D                                       ld   de, (PSGMOD_ADDRESS)
$7D                                       
$A1                                     .MACRO PSGMOD_START_SEQUENCE
$A1                                       ; \1 = Channel
$A1                                       ; \2 = Channel * 2
$F6 $80                                   ; DE = (PSGMOD_ADDRESS)
$F6 $C0                                   
$F6 $A0                                   ; Get pointer to sequence
$D3 $7F                                   ld   c, (hl)
$D3 $7F                                   inc  hl
$D3 $7F                                   .IF \1 != 3
$7C                                       ld   b, (hl)
$7C                                       inc  hl
$7C                                       push hl
$E6 $3F                                   ld   h, b
$E6 $3F                                   .ELSE
$E6 $3F                                   ld   h, (hl)
$D3 $7F                                   .ENDIF
$D3 $7F                                   ld   l, c
$D3 $7F                                   add  hl, de
$3E $15                                   ; Get pointer to notes from sequence header
$32 $00 $80                               ld   a, (hl)
$0E $0F                                   add  a, e
$3A $25 $C2                               ld   c, a
$3A $26 $C2                               inc  hl
$3A $23 $C2                               ld   a, d
$3A $24 $C2                               adc  a, (hl)
$21 $27 $C2                               ld   b, a
$2E $2D                                   ld   (PSGMOD_NOTES_PTR + \2), bc
$2E $29                                   inc  hl
$2E $2B                                   .IF \1 == 0
$86                                       ; Get sequence length from sequence header
$86                                       ld   a, (hl)
$86                                       ld   (PSGMOD_SEQ_LENGTH_CNT), a ; nur einmal
$86                                       .ENDIF
$32 $25 $C2                               inc  hl
$32 $24 $C2                               ld   (PSGMOD_SEQ_PTR + \2), hl
$32 $26 $C2                               .IF \1 != 3
$32 $23 $C2                               pop  hl
$2C                                       .ENDIF
$2C                                     .ENDM
$2C                                       
$2C                                       PSGMOD_START_SEQUENCE 0, 0
$35                                       PSGMOD_START_SEQUENCE 1, 2
$35                                       PSGMOD_START_SEQUENCE 2, 4
$35                                       PSGMOD_START_SEQUENCE 3, 6
$35                                       ret
$C0                                       
$C2 $52 $03                             PSGMOD_Play_TriggerLine:
$C2 $FE $02                               ; A = (PSGMOD_SPEED_CNT)
$C2 $28 $03                               ; Schon vorzeitig Speed dazuzählen, obwohl sich die
$54                                       ; Geschwindigkeit in dieser Zeile ändern könnte.
$54                                       ld   hl, PSGMOD_SPEED
$54                                       add  a, (hl)
$54                                       .IF PSGMOD_SPEED_CNT != PSGMOD_SPEED + 1
$25                                         .FAIL
$25                                       .ENDIF
$25                                       inc  l
$25                                       ld   (hl), a
$3A $1F $C2                               
$3A $22 $C2                               .IF PSGMOD_PULSE_VIBRATO_MASK != PSGMOD_SPEED_CNT + 1
$3A $21 $C2                                 .FAIL
$3A $20 $C2                               .ENDIF
$6F                                       inc  l
$6F                                       rrc  (hl)
$6F                                       
$6F                                       ld   a, (PSGMOD_FRAME)
$1E $2D                                   ld   (PSGMOD_MAPPER_ADDRESS), a
$1E $27                                   
$1E $29                                 .MACRO _PSGMOD_PLAY_CHANNEL
$1E $2B                                 PSGMOD_Play_Ch\1:
$ED $A0                                   .IF \1 == 0
$ED $A0                                   ld   l, (PSGMOD_SEQ_WAIT + \1) & 255
$ED $A0                                   .ELSE
$ED $A0                                   ld   hl, PSGMOD_SEQ_WAIT+\1
$ED $A0                                   .ENDIF
$ED $A0                                   dec  (hl)
$ED $A0                                   jp   NZ, PSGMOD_Play_Ch\1_Done
$ED $A0                                   
$7E                                     PSGMOD_Play_ExecLine\1:
$7E                                       ld   hl, (PSGMOD_SEQ_PTR + \2)
$7E                                       ld   b, (hl)
$32 $3D $C2                               inc  hl
$32 $3F $C2                               ld   (PSGMOD_SEQ_PTR + \2), hl
$32 $3B $C2                               
$2C                                       ld   a, b
$2C                                       and  $E0
$2C                                       jr   Z, PSGMOD_Play_NoNote\1
$2C                                       
$7D                                       rlca
$7D                                       rlca
$7D                                       rlca
$7D                                       ld   (PSGMOD_SEQ_WAIT + \1), a
$E6 $0F                                   
$E6 $0F                                   ld   hl, (PSGMOD_NOTES_PTR + \2)
$E6 $0F                                   ld   a, b
$E6 $0F                                   and  31
$CA $51 $03                               .IF \1 != 3
$CA $FD $02                                 ; * 3
$CA $27 $03                                 ld   d, a
$CA $75 $03                                 add  a, a
$7D                                         add  a, d
$7D                                         ld   e, a
$7D                                       .ELSE
$7D                                         ; * 2
$32 $1F $C2                                 add  a, a
$32 $22 $C2                                 ld   e, a
$32 $21 $C2                               .ENDIF
$32 $20 $C2                               ld   d, 0
$24                                       add  hl, de
$24                                       ld   b, (hl)
$24                                       inc  hl
$24                                       ld   e, (hl)
$C9                                       .IF \1 != 3
$ED $5B $55 $C2                             inc  hl
$4E                                         ld   d, (hl)
$4E                                       .ENDIF
$4E                                       
$4E                                       .IF \1 == 3
$23                                         ld   a, (PSGMOD_SFX_3_PRIORITY)
$23                                         and  a
$23                                         ld   a, e
$23                                         ld   (PSGMOD_FREQUENCY + \2), a
$46                                         jr   NZ, +
$46                                         out  (PSGMOD_PSG_PORT), a
$46                                       +:
$23                                       .ELSE
$23                                         ; Frequenz
$23                                         ld (PSGMOD_FREQUENCY+\2), de
$E5                                       .ENDIF
$E5                                       
$E5                                       ; Volume
$60                                       ld   a, b
$60                                       and  $0F
$60                                       ld   (PSGMOD_VOLUME+\1), a
$66                                       
$69                                       ; Instrument
$69                                       ld   a, b
$69                                       and  $F0
$69                                       
$19                                       ld   h, PSGMOD_INSTRUMENTS >> 8
$19                                       ld   l, a
$19                                       ld   a, (hl)
$19                                       ld   (PSGMOD_PHASE_VOLUME + \1), a
$7E                                       inc  l
$7E                                       .IF PSGMOD_PHASE_DELAY_0 != PSGMOD_PHASE_VOLUME_ADD_0 + 1
$7E                                         .FAIL
$7E                                       .ENDIF
$83                                       ld   de, PSGMOD_PHASE_VOLUME_ADD_0 + \2
$83                                       ldi
$83                                       ldi
$83                                       .IF \1 != 3
$4F                                       ld   a, (hl)
$4F                                       ld   (PSGMOD_VIBPOS + \2 + 1), a
$4F                                       xor  a
$4F                                       ld   (PSGMOD_VIBPOS + \2), a
$23                                       .ENDIF
$23                                       inc  l
$23                                       
$23                                       ld   a, l
$7A                                       ld   (PSGMOD_INSTR_PTR + \1), a
$7A                                       
$7A                                       jp   PSGMOD_Play_Ch\1_Done
$7A                                       
$8E                                     PSGMOD_Play_NoNote\1:
$8E                                       rrc  b
$8E                                       jp   NC, PSGMOD_Play_NoNote\1_Wait
$8E                                     
$47                                     PSGMOD_Play_NoNote\1_CommandOrEffect:
$47                                       ; B = (rotated) command/effect start byte
$47                                       .IF \1 == 3
$47                                           rrc  b
$ED $43 $47 $C2                               jp   NC, PSGMOD_Play_Effect\1_NoSpeedCommand
$ED $43 $49 $C2                               
$ED $43 $43 $C2                               ld hl, (PSGMOD_SEQ_PTR+\2)
$ED $43 $45 $C2                               ld c, (hl)
$23                                           inc hl
$23                                           ld (PSGMOD_SEQ_PTR+\2), hl
$23                                           
$23                                           ld a, (PSGMOD_SPEED_CNT)
$7E                                           ld hl, PSGMOD_SPEED
$32 $14 $C2                                   sub (hl)
$23                                           ld (hl), c
$23                                           add a, c
$23                                           ld (PSGMOD_SPEED_CNT), a
$23                                           
$22 $0E $C2                                 PSGMOD_Play_Effect\1_NoSpeedCommand:
$22 $08 $C2                                   rrc  b
$22 $0A $C2                                 .IF PSGMOD_SUPPORT_GG_STEREO == 1
$22 $0C $C2                                   jp   NC, PSGMOD_Play_Effect\1_NoStereoCommand
$E1                                           
$E1                                           ld hl, (PSGMOD_SEQ_PTR+\2)
$E1                                           ld a, (hl)
$C9                                           ld (PSGMOD_GG_STEREO), a
$21 $19 $C2                                   inc hl
$86                                           ld (PSGMOD_SEQ_PTR+\2), hl
$2C                                         PSGMOD_Play_Effect\1_NoStereoCommand:
$77                                         .ENDIF
$2C                                           rrc  b
$CB $0E                                       jp   NC, PSGMOD_Play_Effect\1_NoSetVolumeEffect
$3A $4B $C2                                   ld hl, (PSGMOD_SEQ_PTR+\2)
$32 $00 $80                                   ld a, (hl)
$2E $10                                       ld (PSGMOD_VOLUME + \1), a
$21 $13 $C2                                   inc hl
$21 $12 $C2                                   ld (PSGMOD_SEQ_PTR+\2), hl
$21 $11 $C2                                 PSGMOD_Play_Effect\1_NoSetVolumeEffect:
$35                                           rrc  b
$35                                           jp   NC, PSGMOD_Play_Effect\1_NoExt
$35                                           
$35                                           ld  hl, (PSGMOD_SEQ_PTR+\2)
$C2 $69 $04                                   ld  b, (hl)
$C2 $E4 $04                                   inc hl
$C2 $5F $05                                   
$C2 $16 $06                                   rrc b
$2A $08 $C2                                   jp  NC, +
$2A $0E $C2                                   ld  a, (hl)
$2A $0C $C2                                   inc hl
$2A $0A $C2                                   ld  (PSGMOD_PULSE_VIBRATO_MASK), a
$46                                         +:
$46                                           
$46                                           rrc  b
$46                                           jp   NC, +
$23                                           ld   a, (hl)
$23                                           inc  hl
$23                                           call PSGMOD_CallCallback
$23                                         +:
$22 $0C $C2                                   rrc  b
$22 $08 $C2                                   jp   NC, +
$22 $0A $C2                                   ld   a, (hl)
$22 $0E $C2                                   inc  hl
$78                                           call PSGMOD_CallCallback
$78                                         +:
$78                                           ld (PSGMOD_SEQ_PTR + \2), hl
$78                                         PSGMOD_Play_Effect\1_NoExt:
$E6 $E0                                   .ELSE
$E6 $E0                                     ld   hl, (PSGMOD_SEQ_PTR + \2)
$E6 $E0                                     ld   a, (hl)
$E6 $E0                                     inc  hl
$28 $40                                     ld   (PSGMOD_SEQ_PTR + \2), hl
$28 $44                                     rrc  b
$28 $44                                     jp   C, +
$28 $44                                     ld (PSGMOD_PULSE_VIBRATO + \1), a
$07                                         jp   ++
$07                                         +:
$07                                         ld (PSGMOD_VOLUME + \1), a
$07                                         ++:
$07                                       .ENDIF
$07                                       
$07                                       jp   PSGMOD_Play_ExecLine\1
$07                                       
$07                                     PSGMOD_Play_NoNote\1_Wait:
$07                                       ld   a, b
$07                                       inc  a
$07                                       ld   (PSGMOD_SEQ_WAIT+\1), a
$32 $13 $C2                               
$32 $11 $C2                             ;-------------------------------------------------------
$32 $12 $C2                             PSGMOD_Play_Ch\1_Done:
$32 $10 $C2                             .ENDM
$2A $45 $C2                               
$2A $47 $C2                               _PSGMOD_PLAY_CHANNEL 0, 0
$2A $49 $C2                               _PSGMOD_PLAY_CHANNEL 1, 2
$2A $43 $C2                               _PSGMOD_PLAY_CHANNEL 2, 4
$78                                       _PSGMOD_PLAY_CHANNEL 3, 6
$78                                       
$78                                     ;-------------------------------------------------------
$78                                       ;
$E6 $1F                                   ; Next sequence
$E6 $1F                                   ;
$E6 $1F                                   ld   hl, PSGMOD_SEQ_LENGTH_CNT
$E6 $1F                                   dec  (hl)
$57                                       jp   NZ, PSGMOD_Play_TriggerLine_Cont
$57                                       
$57                                       ld   hl, (PSGMOD_LENGTH_CNT)
$87                                       dec  hl
$87                                       ld   (PSGMOD_LENGTH_CNT), hl
$87                                       ld   a, l
$82                                       or   h
$82                                       jr   Z, PSGMOD_Play_Repeat
$82                                       
$5F                                       ld   hl, (PSGMOD_SEQ_LIST_PTR)
$5F                                       ld   de, 8
$5F                                       add  hl, de
$87                                       ld   (PSGMOD_SEQ_LIST_PTR), hl
$5F                                       call PSGMOD_StartSequences
$16 $00                                   jp   PSGMOD_Play_TriggerLine_Cont
$16 $00                                   
$16 $00                                 PSGMOD_Play_Repeat:
$16 $00                                   ld   hl, (PSGMOD_LENGTH)
$19                                       ld   de, (PSGMOD_REPEAT_POINT)
$19                                       and  a                                         ; Clear C-flag
$19                                       sbc  hl, de
$19                                       ld   (PSGMOD_LENGTH_CNT), hl
$46                                       
$46                                       ld   a, 7
$46                                       ld   (PSGMOD_SPEED_CNT), a
$46                                       
$23                                       ld   hl, (PSGMOD_REPEAT_POINT)
$23                                       add  hl, hl
$23                                       add  hl, hl
$23                                       add  hl, hl
$5E                                       ld   de, (PSGMOD_SEQ_LIST_START_PTR)
$5E                                       add  hl, de
$5E                                       ld   (PSGMOD_SEQ_LIST_PTR), hl
$5E                                       
$23                                       call PSGMOD_StartSequences
$23                                       jp   PSGMOD_Play_TriggerLine_Cont
$23                                       
$56                                     ;----------------------------------------------------------
$56                                     ; PSGMOD_PlaySFX_2(B = length, C = priority, HL = address)
$56                                     PSGMOD_PlaySFX_2:
$3A $4E $C2                               ld a, (PSGMOD_SFX_2_PRIORITY)
$A7                                       cp c
$7B                                       jr Z, PSGMOD_PlaySFX_2_OK
$32 $35 $C2                               ret NC
$20 $02                                 PSGMOD_PlaySFX_2_OK:
$D3 $7F                                   
$ED $53 $31 $C2                           ld a, b
$ED $53 $33 $C2                           ld (PSGMOD_SFX_2_CNT), a
$ED $53 $2F $C2                           ld a, c
$78                                       ld (PSGMOD_SFX_2_PRIORITY), a
$78                                       ld (PSGMOD_SFX_2_ADDRESS), hl
$78                                       ret
$78                                     
$E6 $0F                                 ;----------------------------------------------------------
$E6 $0F                                 ; PSGMOD_PlaySFX_3(B = length, C = priority, HL = address)
$E6 $0F                                 PSGMOD_PlaySFX_3:
$E6 $0F                                   ld a, (PSGMOD_SFX_3_PRIORITY)
$32 $38 $C2                               cp c
$32 $37 $C2                               jr Z, PSGMOD_PlaySFX_3_OK
$32 $39 $C2                               ret NC
$32 $36 $C2                             PSGMOD_PlaySFX_3_OK:
$78                                       
$78                                       ld a, b
$78                                       ld (PSGMOD_SFX_3_CNT), a
$78                                       ld a, c
$E6 $F0                                   ld (PSGMOD_SFX_3_PRIORITY), a
$E6 $F0                                   ld (PSGMOD_SFX_3_ADDRESS), hl
$E6 $F0                                   ret
$E6 $F0                                 
$26 $C1                                 ;----------------------------------------------------------
$26 $C1                                 ; PSGMOD_PlaySFX_23(B = length, C = priority, HL = address)
$26 $C1                                 PSGMOD_PlaySFX_23:
$26 $C1                                   ld a, (PSGMOD_SFX_3_PRIORITY)
$6F                                       cp c
$6F                                       jr Z, PSGMOD_PlaySFX_23_OK_3
$6F                                       ret NC
$6F                                     PSGMOD_PlaySFX_23_OK_3:
$7E                                       
$7E                                       ld a, (PSGMOD_SFX_2_PRIORITY)
$7E                                       cp c
$7E                                       jr Z, PSGMOD_PlaySFX_23_OK_2
$32 $25 $C2                               ret NC
$32 $26 $C2                             PSGMOD_PlaySFX_23_OK_2:
$32 $24 $C2                               
$32 $23 $C2                               ld a, b
$2C                                       ld (PSGMOD_SFX_2_CNT), a
$2C                                       ld (PSGMOD_SFX_3_CNT), a
$2C                                       ld a, c
$2C                                       ld (PSGMOD_SFX_2_PRIORITY), a
$11 $29 $C2                               ld (PSGMOD_SFX_3_PRIORITY), a
$11 $2B $C2                               
$11 $27 $C2                               ld (PSGMOD_SFX_2_ADDRESS), hl
$11 $2D $C2                               ld c, b
$ED $A0                                   ld b, 0
$ED $A0                                   add hl, bc
$ED $A0                                   add hl, bc
$ED $A0                                   add hl, bc
$ED $A0                                   ld (PSGMOD_SFX_3_ADDRESS), hl
$ED $A0                                   ret
$ED $A0                                 
$ED $A0                                 ;------------------
$7E                                     ; PSGMOD_StopSFX()
$7E                                     PSGMOD_StopSFX:
$7E                                       ld a, (PSGMOD_SFX_2_PRIORITY)
$32 $3B $C2                               or a
$32 $3F $C2                               jr Z, PSGMOD_StopSFX_2
$32 $3D $C2                               
$AF                                       xor a
$AF                                       ld (PSGMOD_SFX_2_PRIORITY), a
$AF                                       
$32 $3C $C2                               ld a, (PSGMOD_PULSE_VIBRATO_MASK)
$32 $3E $C2                               or a
$32 $3A $C2                               ld hl, (PSGMOD_FREQUENCY+4)
$2C                                       jr Z, PSGMOD_StopSFX_ResetFreq2_NoVib
$2C                                       ld d, 0
$2C                                       ld a, (PSGMOD_PULSE_VIBRATO + 2)
$2C                                       ld e, a
$7D                                       add hl, de
$7D                                     PSGMOD_StopSFX_ResetFreq2_NoVib:
$7D                                       
$7D                                       ld a, l
$32 $1F $C2                               and 15
$32 $21 $C2                               or 128+64
$32 $20 $C2                               out (PSGMOD_PSG_PORT), a
$32 $22 $C2                               
$C3 $69 $04                               ld a, l
$C3 $E4 $04                               rrca
$C3 $5F $05                               rrca
$C3 $16 $06                               rrca
$CB $08                                   rrca
$CB $08                                   and 15
$CB $08                                   ld b, a
$CB $08                                   ld a, h
$D2 $DF $04                               and 3
$D2 $5A $05                               rrca
$D2 $64 $04                               rrca
$D2 $11 $06                               rrca
$CB $08                                   rrca
$D2 $D1 $05                               or b
$2A $0E $C2                               out (PSGMOD_PSG_PORT), a
$4E                                       ;
$23                                       ;
$22 $0E $C2                               ;
$3A $1A $C2                             PSGMOD_StopSFX_2:
$21 $19 $C2                               
$96                                       ld   a, (PSGMOD_SFX_3_PRIORITY)
$71                                       or   a
$81                                       ret  Z
$32 $1A $C2                               
$CB $08                                   xor  a
$CB $08                                   ld   (PSGMOD_SFX_3_PRIORITY), a
$D2 $E3 $05                               
$2A $0E $C2                               ld   a, (PSGMOD_FREQUENCY + 6)
$7E                                       out  (PSGMOD_PSG_PORT), a
$32 $39 $C2                               ret
$23                                     
$22 $0E $C2                             ;--------------------
$CB $08                                 PSGMOD_CallCallback:
$D2 $0E $06                             ; (A)
$2A $0E $C2                               push hl
$46                                       push bc
$23                                       ld   hl, (PSGMOD_CALLBACK_FUNCTION)
$CB $08                                   call PSGMOD_JumpHL
$D2 $F7 $05                               pop  bc
$7E                                       pop  hl
$23                                       ret
$32 $1B $C2                               
$CB $08                                 PSGMOD_JumpHL:
$D2 $01 $06                               jp   (hl)
$7E                                     
$23                                     ;------------------------------
$CD $EF $06                             ; PSGMOD_SetCallbackFunction()
$CB $08                                 PSGMOD_SetCallbackFunction:
$D2 $0B $06                               ld   (PSGMOD_CALLBACK_FUNCTION), hl
$7E                                       ret
$23                                     $CD $EF $06                             $22 $0E $C2                             $2A $08 $C2                             $2A $0A $C2                             $2A $0C $C2                             $7E                                     $7E                                     $7E                                     $23                                     $23                                     $23                                     $22 $08 $C2                             $22 $0C $C2                             $22 $0A $C2                             $CB $08                                 $CB $08                                 $CB $08                                 $DA $5E $04                             $DA $D9 $04                             $DA $54 $05                             $32 $41 $C2                             $32 $42 $C2                             $32 $40 $C2                             $C3 $61 $04                             $C3 $57 $05                             $C3 $DC $04                             $32 $36 $C2                             $32 $38 $C2                             $32 $37 $C2                             $C3 $70 $04                             $C3 $EB $04                             $C3 $F5 $03                             $C3 $66 $05                             $78                                     $78                                     $78                                     $78                                     $3C                                     $3C                                     $3C                                     $3C                                     $32 $12 $C2                             $32 $13 $C2                             $32 $11 $C2                             $32 $10 $C2                             $21 $14 $C2                             $35                                     $C2 $5E $01                             $2A $06 $C2                             $2B                                     $22 $06 $C2                             $7D                                     $B4                                     $28 $10                                 $2A $02 $C2                             $11 $08 $00                             $19                                     $22 $02 $C2                             $CD $77 $03                             $C3 $5E $01                             $2A $04 $C2                             $ED $5B $17 $C2                         $A7                                     $ED $52                                 $22 $06 $C2                             $3E $07                                 $32 $1A $C2                             $2A $17 $C2                             $29                                     $29                                     $29                                     $ED $5B $00 $C2                         $19                                     $22 $02 $C2                             $CD $77 $03                             $C3 $5E $01                             $3A $4D $C2                             $B9                                     $28 $01                                 $D0                                     $78                                     $32 $4F $C2                             $79                                     $32 $4D $C2                             $22 $51 $C2                             $C9                                     $3A $4E $C2                             $B9                                     $28 $01                                 $D0                                     $78                                     $32 $50 $C2                             $79                                     $32 $4E $C2                             $22 $53 $C2                             $C9                                     $3A $4E $C2                             $B9                                     $28 $01                                 $D0                                     $3A $4D $C2                             $B9                                     $28 $01                                 $D0                                     $78                                     $32 $4F $C2                             $32 $50 $C2                             $79                                     $32 $4D $C2                             $32 $4E $C2                             $22 $51 $C2                             $48                                     $06 $00                                 $09                                     $09                                     $09                                     $22 $53 $C2                             $C9                                     $3A $4D $C2                             $B7                                     $28 $2D                                 $AF                                     $32 $4D $C2                             $3A $1B $C2                             $B7                                     $2A $33 $C2                             $28 $07                                 $16 $00                                 $3A $42 $C2                             $5F                                     $19                                     $7D                                     $E6 $0F                                 $F6 $C0                                 $D3 $7F                                 $7D                                     $0F                                     $0F                                     $0F                                     $0F                                     $E6 $0F                                 $47                                     $7C                                     $E6 $03                                 $0F                                     $0F                                     $0F                                     $0F                                     $B0                                     $D3 $7F                                 $3A $4E $C2                             $B7                                     $C8                                     $AF                                     $32 $4E $C2                             $3A $35 $C2                             $D3 $7F                                 $C9                                     $E5                                     $C5                                     $2A $1D $C2                             $CD $FA $06                             $C1                                     $E1                                     $C9                                     $E9                                     $22 $1D $C2                             $C9                                     